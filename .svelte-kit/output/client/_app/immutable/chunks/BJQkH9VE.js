import{a as D}from"./D8PmxC0_.js";class U{async getFichaComplete(o){var e,d,a,s,g,u,t,v,E,h,A,b,C,F,q;console.log("ğŸ“‹ FichaQueryAdapter: Buscando dados da ficha via endpoints especÃ­ficos:",o);try{const r=await D.get(`/fichas-epi/${o}/complete`);console.log("ğŸ” DEBUG Colaborador ID da ficha:",(a=(d=(e=r==null?void 0:r.data)==null?void 0:e.ficha)==null?void 0:d.colaborador)==null?void 0:a.id);const I=(u=(g=(s=r==null?void 0:r.data)==null?void 0:s.ficha)==null?void 0:g.colaborador)==null?void 0:u.id;console.log("ğŸ” DEBUG Colaborador ID para devoluÃ§Ãµes:",I);const[y,S]=await Promise.all([D.get(`/fichas-epi/${o}/entregas`),this.buscarDevolucoes(o,I)]);console.log("âœ… Dados da ficha carregados via endpoints especÃ­ficos"),console.log("ğŸ” DEBUG Entregas do backend:",(t=y==null?void 0:y.data)==null?void 0:t[0]),console.log("ğŸ” DEBUG Complete response:",{devolucoes:((E=(v=r==null?void 0:r.data)==null?void 0:v.devolucoes)==null?void 0:E.length)||0,devolucoesData:(h=r==null?void 0:r.data)==null?void 0:h.devolucoes,fullStructure:Object.keys((r==null?void 0:r.data)||{})});let P={};try{(await this.getEPIsDisponiveis()).forEach(c=>{c.tipoEpiId&&(P[c.tipoEpiId]={nomeEquipamento:c.nomeEquipamento,numeroCA:c.numeroCA,categoria:c.categoria})}),console.log("ğŸ” EPI Lookup criado:",Object.keys(P).length,"tipos EPI")}catch(l){console.warn("âš ï¸ Erro ao criar lookup de EPIs:",l)}if(y&&y.data&&Array.isArray(y.data)&&(r.data.entregas=y.data.map(l=>{var c,m,n,f;return console.log("ğŸ” DEBUG Entrega individual:",{id:l.id,status:l.status,itens:((c=l.itens)==null?void 0:c.length)||0,itemSample:(m=l.itens)==null?void 0:m[0],itemSampleFull:JSON.stringify((n=l.itens)==null?void 0:n[0],null,2)}),{id:l.id,numero:l.numero||l.id,dataEntrega:l.dataEntrega||l.createdAt,status:l.status||"PENDENTE_ASSINATURA",statusDisplay:{cor:l.status==="ASSINADA"||l.status==="assinada"?"green":"yellow",label:l.status==="ASSINADA"||l.status==="assinada"?"Assinado":"Pendente Assinatura"},acoes:l.status==="ASSINADA"||l.status==="assinada"?["imprimir"]:["assinar","cancelar"],itens:((f=l.itens)==null?void 0:f.map(p=>{var N;console.log("ğŸ” DEBUG Item raw:",JSON.stringify(p,null,2));const w=P[p.tipoEpiId],i=((N=p.estoqueItem)==null?void 0:N.tipoEpi)||p.tipoEpi||p.equipamento||w||p,B=p.estoqueItem||p;return console.log("ğŸ” DEBUG EPI Data (com lookup):",i),console.log("ğŸ” DEBUG Lookup result para",p.tipoEpiId,":",w),{id:p.id,nomeEquipamento:(i==null?void 0:i.nomeEquipamento)||(i==null?void 0:i.nome)||(i==null?void 0:i.nome_equipamento)||"Nome nÃ£o disponÃ­vel",numeroCA:(i==null?void 0:i.numeroCa)||(i==null?void 0:i.numeroCA)||(i==null?void 0:i.numero_ca)||(i==null?void 0:i.ca)||"N/A",categoria:(i==null?void 0:i.categoriaEpi)||(i==null?void 0:i.categoria)||(i==null?void 0:i.category)||"NÃ£o informado",quantidade:p.quantidade||p.quantidadeEntregue||1,status:p.status}}))||[]}})),console.log("ğŸ”„ Carregando devoluÃ§Ãµes via endpoint oficial..."),I){console.log("ğŸ”„ Buscando devoluÃ§Ãµes para colaborador:",I);try{const m=(await this.getDevolucoesByColaborador(I)).map(n=>({id:n.entregaId||n.id||`dev-${Date.now()}`,nomeEquipamento:n.tipoEpiNome||n.nomeEquipamento||"Nome nÃ£o disponÃ­vel",numeroCA:n.tipoEpiCodigo||n.numeroCA||"N/A",categoria:n.tipoEpiCategoria||n.categoria||"NÃ£o informado",quantidade:1,dataDevolucao:n.dataDevolucao||"Data nÃ£o disponÃ­vel",motivo:n.motivoDevolucao||n.motivo||"Motivo nÃ£o informado",motivoDisplay:n.motivoDevolucao||n.motivo||"Motivo nÃ£o informado",condicaoItem:n.condicaoItem||"BOM",observacoes:n.observacoes||"",status:"processada",podeProcessar:!1,podeCancelar:!1,entregaId:n.entregaId,numeroSerie:n.numeroSerie,dataEntrega:n.dataEntrega,tempoUso:n.diasUso||n.tempoUso||0,responsavel:n.responsavelNome||n.responsavel||"NÃ£o informado"}));r.data.devolucoes=m,console.log("âœ… DevoluÃ§Ãµes carregadas via endpoint oficial:",m.length),m.length>0&&console.log("ğŸ” Primeira devoluÃ§Ã£o formatada:",m[0])}catch(c){console.error("âŒ Erro ao carregar devoluÃ§Ãµes via endpoint:",c),r.data.devolucoes=[]}let l=0;if(console.log("ğŸ” DEBUG: Verificando itens devolvidos nas entregas..."),console.log("ğŸ” DEBUG: Total de entregas:",((A=r.data.entregas)==null?void 0:A.length)||0),(b=r.data.entregas)==null||b.forEach((c,m)=>{var n,f;console.log(`ğŸ” DEBUG: Entrega ${m} (${c.id}) tem ${((n=c.itens)==null?void 0:n.length)||0} itens`),(f=c.itens)==null||f.forEach((p,w)=>{console.log(`ğŸ” DEBUG: Item ${w} - status: "${p.status}"`),p.status==="DEVOLVIDO"&&(l++,console.log(`âœ… DEBUG: Item devolvido encontrado! Total: ${l}`))})}),console.log(`ğŸ“‹ DEBUG: Total de itens com status DEVOLVIDO: ${l}`),l>0){console.log("ğŸ’¡ PROBLEMA IDENTIFICADO: O endpoint /api/teste-devolucoes/historico-global retorna array vazio, mas existem devoluÃ§Ãµes nos dados das entregas"),console.log("ğŸ’¡ SOLUÃ‡ÃƒO: Extrair devoluÃ§Ãµes dos dados das entregas atÃ© o endpoint ser corrigido");const c=[];(C=r.data.entregas)==null||C.forEach(m=>{var n;(n=m.itens)==null||n.forEach(f=>{f.status==="DEVOLVIDO"&&c.push({id:`dev-${f.id}-${Date.now()}`,nomeEquipamento:f.nomeEquipamento,numeroCA:f.numeroCA,categoria:f.categoria,quantidade:f.quantidade||1,dataDevolucao:m.dataEntrega,motivo:"Motivo nÃ£o especificado",motivoDisplay:"Motivo nÃ£o especificado",condicaoItem:"BOM",observacoes:`Item devolvido da entrega ${m.numero}`,status:"processada",podeProcessar:!1,podeCancelar:!1,entregaId:m.id,numeroSerie:`SER-${f.id}`,dataEntrega:m.dataEntrega,tempoUso:0,responsavel:"Sistema"})})}),c.length>0&&r.data.devolucoes.length===0&&(r.data.devolucoes=c,console.log(`âœ… SOLUÃ‡ÃƒO APLICADA: ${c.length} devoluÃ§Ãµes extraÃ­das dos dados das entregas`))}else console.log("â„¹ï¸ Nenhum item com status DEVOLVIDO encontrado nas entregas")}else console.warn("âš ï¸ Colaborador ID nÃ£o encontrado, nÃ£o Ã© possÃ­vel carregar devoluÃ§Ãµes"),r.data.devolucoes=[];return console.log("ğŸ“Š Dados finais - Entregas:",((F=r.data.entregas)==null?void 0:F.length)||0),console.log("ğŸ“Š Dados finais - DevoluÃ§Ãµes:",((q=r.data.devolucoes)==null?void 0:q.length)||0),r}catch(r){throw console.error("âŒ Erro ao buscar dados da ficha:",r),r}}async getEquipamentosEmPosse(o){console.log("ğŸ“¦ FichaQueryAdapter: Buscando equipamentos em posse:",o);try{const e=await D.get(`/fichas-epi/colaborador/${o}/posse-atual`);return console.log("âœ… Equipamentos em posse carregados"),e}catch(e){throw console.error("âŒ Erro ao buscar equipamentos em posse:",e),e}}async getFichasList(o){console.log("ğŸ“‹ FichaQueryAdapter: Listando fichas com API documentada:",o);try{const e=new URLSearchParams;o.page&&e.set("page",o.page.toString()),o.limit&&e.set("limit",o.limit.toString()),o.search&&o.search.trim()&&(e.set("search",o.search.trim()),console.log("ğŸ” Aplicando busca unificada:",o.search.trim())),o.status&&o.status!=="todos"&&(e.set("status",o.status.toUpperCase()),console.log("ğŸ”§ Filtro status aplicado:",o.status.toUpperCase())),o.empresa&&o.empresa!=="todas"&&(e.set("empresa",o.empresa),console.log("ğŸ”§ Filtro empresa aplicado (por nome):",o.empresa)),o.cargo&&o.cargo!=="todos"&&(e.set("cargo",o.cargo),console.log("ğŸ”§ Filtro cargo aplicado:",o.cargo)),o.empresaFilter&&o.empresaFilter!=="todas"&&(e.set("empresaId",o.empresaFilter),console.log("ğŸ”§ Filtro empresa aplicado (empresaId):",o.empresaFilter)),(o.vencimentoProximo||o.devolucaoPendente)&&(e.set("devolucaoPendente","true"),console.log("ğŸ”§ Filtro devoluÃ§Ã£o pendente aplicado")),o.searchTerm&&o.searchTerm.trim()&&(e.set("search",o.searchTerm.trim()),console.log("ğŸ”§ Busca unificada (alias) aplicada:",o.searchTerm.trim()));const d=`/fichas-epi/list-enhanced${e.toString()?"?"+e.toString():""}`;console.log("ğŸŒ Endpoint enhanced documentado:",d),console.log("ğŸ”§ ParÃ¢metros enviados:",Object.fromEntries(e.entries())),console.log("ğŸ” Debug filtros originais:",{search:o.search,empresa:o.empresa,cargo:o.cargo,empresaFilter:o.empresaFilter});const a=await D.get(d);console.log("ğŸ“¥ Resposta bruta do backend:",{success:a.success,dataType:Array.isArray(a.data)?"array":typeof a.data,dataLength:Array.isArray(a.data)?a.data.length:"N/A",hasPagination:!!a.pagination,endpointUsado:d}),o.empresa&&o.empresa!=="todas"&&Array.isArray(a.data)&&console.log("ğŸ” DEBUG FILTRO EMPRESA:",{empresaFiltrada:o.empresa,totalItensRetornados:a.data.length,primeirosItens:a.data.slice(0,2).map(u=>{var t,v,E;return{id:u.id,colaboradorNome:(t=u.colaborador)==null?void 0:t.nome,contratadaId:(v=u.contratada)==null?void 0:v.id,contratadaNome:(E=u.contratada)==null?void 0:E.nome}})});let s=[],g={page:o.page||1,limit:o.limit||10,total:0,totalPages:1};if(a.success){let u=[];Array.isArray(a.data)?(u=a.data,g.total=u.length,g.totalPages=Math.ceil(g.total/g.limit)):a.data&&typeof a.data=="object"&&("items"in a.data?(u=a.data.items||[],"pagination"in a.data&&(g={...g,...a.data.pagination})):(console.warn("âš ï¸ Formato de resposta inesperado:",a.data),u=[])),a.pagination&&(g={...g,...a.pagination}),u.length>0&&console.log("ğŸ” DEBUG Estrutura completa do primeiro item:",JSON.stringify(u[0],null,2)),s=u.map(t=>{var v,E,h,A,b,C,F,q,r,I,y,S,P,l,c;return console.log("ğŸ”§ Transformando item da API:",{id:t.id,colaboradorNome:(v=t.colaborador)==null?void 0:v.nome,colaboradorCPF:(E=t.colaborador)==null?void 0:E.cpf,colaboradorCPFFormatado:(h=t.colaborador)==null?void 0:h.cpfFormatado,contratadaNome:(A=t.contratada)==null?void 0:A.nome,colaboradorEmpresa:(b=t.colaborador)==null?void 0:b.empresa,colaboradorCargo:(C=t.colaborador)==null?void 0:C.cargo}),{id:t.id,colaborador:{nome:((F=t.colaborador)==null?void 0:F.nome)||"Nome nÃ£o informado",cpf:((q=t.colaborador)==null?void 0:q.cpf)||((r=t.colaborador)==null?void 0:r.cpfFormatado)||"CPF nÃ£o disponÃ­vel",matricula:((I=t.colaborador)==null?void 0:I.matricula)||"",cargo:((y=t.colaborador)==null?void 0:y.cargo)||"",empresa:((S=t.contratada)==null?void 0:S.nome)||((P=t.colaborador)==null?void 0:P.empresa)||"Empresa nÃ£o informada"},contratada:t.contratada?{id:t.contratada.id,nome:t.contratada.nome}:void 0,status:(t.status||"ativa").toLowerCase(),totalEpisAtivos:t.totalEpisAtivos||((l=t.episInfo)==null?void 0:l.totalEpisComColaborador)||0,totalEpisVencidos:t.totalEpisVencidos||((c=t.episInfo)==null?void 0:c.episExpirados)||0,episInfo:t.episInfo,proximoVencimento:t.proximoVencimento,ultimaAtualizacao:t.ultimaAtualizacao,devolucaoPendente:t.devolucaoPendente||!1}}),console.log("âœ… Dados transformados para frontend:",{originalCount:u.length,transformedCount:s.length,firstItemStructure:s[0]?{colaboradorNome:s[0].colaborador.nome,colaboradorEmpresa:s[0].colaborador.empresa,colaboradorCargo:s[0].colaborador.cargo,hasContratada:!!s[0].contratada}:null})}return console.log("âœ… Lista de fichas processada:",{totalItens:s.length,paginaAtual:g.page,totalPaginas:g.totalPages,totalRegistros:g.total}),{items:s,pagination:g}}catch(e){throw console.error("âŒ Erro ao listar fichas:",e),e}}async getFichaById(o){console.log("ğŸ“‹ FichaQueryAdapter: Busca simples da ficha:",o);try{const e=await D.get(`/fichas-epi/${o}`);return console.log("âœ… Ficha simples carregada (fallback)"),e}catch(e){throw console.error("âŒ Erro ao buscar ficha simples:",e),e}}async getEPIsDisponiveis(){console.log("ğŸ“¦ FichaQueryAdapter: Buscando EPIs disponÃ­veis via /estoque/itens...");try{const o=await D.get("/estoque/itens");console.log("âœ… EPIs obtidos via /estoque/itens:",o),console.log("âœ… EPIs disponÃ­veis - resposta raw:",o),console.log("ğŸ” Estrutura completa da resposta:",JSON.stringify(o,null,2));let e=[];if(o&&Array.isArray(o))e=o;else if(o&&o.data){if(Array.isArray(o.data))e=o.data;else if(o.data.items&&Array.isArray(o.data.items))e=o.data.items;else if(o.data.posicoes&&Array.isArray(o.data.posicoes))e=o.data.posicoes;else if(o.data.itens&&Array.isArray(o.data.itens))e=o.data.itens;else if(typeof o.data=="object"){const s=Object.values(o.data).find(g=>Array.isArray(g));s?e=s:(console.warn("âš ï¸ NÃ£o foi possÃ­vel encontrar array nos dados:",o.data),e=[])}}else o&&o.items&&Array.isArray(o.items)?e=o.items:(console.warn("âš ï¸ Formato de EPIs inesperado:",o),console.log("ğŸ” Estrutura da resposta:",Object.keys(o||{})),e=[]);const d=e.map(a=>{var A,b;console.log("ğŸ” Item original:",a);const s=a.tipoEpi||a,g=a.quantidade||a.saldoDisponivel||a.quantidadeAtual||s.quantidadeDisponivel||s.quantidade_disponivel||0,u=a.id||a.tipoEpiId||s.id,t=a.tipoEpiId||s.id||a.id,v=a.tipoEpiNome||s.nomeEquipamento||s.nome_equipamento||s.nome||s.equipment_name,E=a.tipoEpiCodigo||s.numeroCa||s.numeroCA||s.numero_ca||s.registroCA||s.registro_ca||s.ca_number||s.ca;if(!u||!v)return console.warn("âš ï¸ Item ignorado por falta de dados essenciais:",a),null;const h={id:u,estoqueItemId:u,episDisponivelId:u,tipoEpiId:t,posicaoEstoqueId:u,nomeEquipamento:v,numeroCA:E||"N/A",registroCA:E||"N/A",categoria:s.categoria||s.category||s.tipo||"NÃ£o informado",quantidadeDisponivel:g,disponivel:g>0,almoxarifado:a.almoxarifadoNome||((A=a.almoxarifado)==null?void 0:A.nome)||"Central",almoxarifadoId:a.almoxarifadoId||((b=a.almoxarifado)==null?void 0:b.id),situacao:a.situacao,saldoTotal:a.saldoTotal,saldoReservado:a.saldoReservado};return console.log("ğŸ¯ EPI processado:",{id:h.id,nome:h.nomeEquipamento,quantidade:h.quantidadeDisponivel,disponivel:h.disponivel}),h}).filter(Boolean).filter(a=>a.disponivel&&a.quantidadeDisponivel>0);return console.log("âœ… EPIs normalizados:",d.length),console.log("ğŸ“¦ Amostra de EPIs:",d.slice(0,2)),d}catch(o){throw console.error("âŒ Erro ao buscar EPIs disponÃ­veis:",o),o}}async getUsuarios(){console.log("ğŸ‘¥ FichaQueryAdapter: Buscando usuÃ¡rios...");try{const o=await D.get("/usuarios");if(console.log("âœ… UsuÃ¡rios carregados"),o&&Array.isArray(o))return o;if(o&&o.data&&Array.isArray(o.data))return o.data;if(o&&o.items&&Array.isArray(o.items))return console.log("ğŸ“Š UsuÃ¡rios vÃªm em formato paginado, extraindo items"),o.items;throw console.error("âŒ Formato de usuÃ¡rios inesperado:",o),new Error("Formato de resposta de usuÃ¡rios invÃ¡lido")}catch(o){throw console.error("âŒ Erro ao buscar usuÃ¡rios:",o),o}}async buscarDevolucoes(o,e){console.log("ğŸ”„ FichaQueryAdapter: Buscando devoluÃ§Ãµes via endpoint oficial");try{if(e&&e.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/)){const d=await this.getDevolucoesByColaborador(e);return console.log("âœ… DevoluÃ§Ãµes encontradas via endpoint oficial:",d.length),d}else return console.log("âš ï¸ Colaborador ID invÃ¡lido para UUID:",e),[]}catch(d){return console.error("âŒ Erro ao buscar devoluÃ§Ãµes via endpoint oficial:",d),[]}}async getDevolucoesByColaborador(o){var d;if(console.log("ğŸ”„ FichaQueryAdapter: Buscando devoluÃ§Ãµes do colaborador:",o),!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(o))return console.warn("âš ï¸ Colaborador ID nÃ£o Ã© um UUID vÃ¡lido:",o),[];try{const a=await D.get("/teste-devolucoes/historico-global",{params:{colaboradorId:o,limit:100}});console.log("âœ… Response do endpoint de devoluÃ§Ãµes:",a);let s=[];return a&&a.success&&a.data?(a.data.devolucoes&&Array.isArray(a.data.devolucoes)?(s=a.data.devolucoes,console.log("ğŸ“‹ DevoluÃ§Ãµes encontradas (formato padrÃ£o):",s.length)):Array.isArray(a.data)?(s=a.data,console.log("ğŸ“‹ DevoluÃ§Ãµes encontradas (formato direto):",s.length)):console.warn("âš ï¸ Resposta nÃ£o contÃ©m devoluÃ§Ãµes no formato esperado:",{hasSuccess:!!(a!=null&&a.success),hasData:!!(a!=null&&a.data),hasDevolucoes:!!((d=a==null?void 0:a.data)!=null&&d.devolucoes),isDataArray:Array.isArray(a==null?void 0:a.data),responseStructure:Object.keys(a||{}),dataStructure:Object.keys((a==null?void 0:a.data)||{})}),s.length>0&&console.log("ğŸ“‹ Estrutura da primeira devoluÃ§Ã£o:",s[0]),a.data.estatisticas&&console.log("ğŸ“Š EstatÃ­sticas:",a.data.estatisticas)):console.warn("âš ï¸ Resposta invÃ¡lida do endpoint:",{hasResponse:!!a,hasSuccess:!!(a!=null&&a.success),hasData:!!(a!=null&&a.data)}),s}catch(a){if(console.error("âŒ Erro ao buscar devoluÃ§Ãµes:",a),a.response&&(console.error("âŒ Status HTTP:",a.response.status),console.error("âŒ Dados da resposta:",a.response.data),a.response.status===400))return console.warn("âš ï¸ Erro de validaÃ§Ã£o 400 - retornando array vazio"),[];throw a}}async getFichasWithColaboradores(o){console.log("ğŸ“‹ FichaQueryAdapter: MÃ©todo transitÃ³rio com busca unificada - getFichasWithColaboradores",o);const e={page:o.page,limit:o.limit,search:o.searchTerm||o.search,empresa:o.empresaFilter||o.empresa,cargo:o.cargoFilter||o.cargo,status:o.statusFilter||o.status,vencimentoProximo:o.devolucaoPendente||o.vencimentoProximo};console.log("ğŸ” ParÃ¢metros convertidos para busca unificada:",{search:e.search,empresa:e.empresa,cargo:e.cargo,status:e.status,page:e.page,limit:e.limit});try{const d=await this.getFichasList(e),a={fichas:d.items,total:d.pagination.total,page:d.pagination.page,pageSize:d.pagination.limit,totalPages:d.pagination.totalPages};return console.log("âœ… Resposta convertida para formato antigo:",{totalFichas:a.fichas.length,total:a.total,page:a.page,totalPages:a.totalPages}),a}catch(d){throw console.error("âŒ Erro no mÃ©todo transitÃ³rio:",d),d}}}const L=new U;export{L as f};
