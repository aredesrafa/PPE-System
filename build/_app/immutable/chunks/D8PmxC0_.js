const R=(()=>{if(typeof window>"u")return"https://epi-backend-s14g.onrender.com/api";const t=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";return window.location.hostname.includes("github.io"),t&&window.location.port!==""?"/api":"https://epi-backend-s14g.onrender.com/api"})();class i extends Error{constructor(s,o,r,a){super(s),this.status=o,this.response=r,this.endpoint=a,this.name="ApiError"}get isAuthError(){return this.status===401||this.status===403}get isNetworkError(){return this.status===0||this.status>=500}get isClientError(){return this.status>=400&&this.status<500}}const k={timeout:3e4,retries:3,retryDelay:2e3};async function l(t,s={}){const o={...k,...s},{skipAuth:r=!1,timeout:a,retries:n,retryDelay:u,...c}=o,d=new Headers(c.headers);d.set("Content-Type","application/json"),d.set("Accept","application/json"),typeof window<"u"&&window.location.hostname.includes("github.io")&&d.set("Origin",window.location.origin);async function f(p=1){var y,T;let h;if(t.startsWith("http"))h=t;else{const e=t.startsWith("/")?t:"/"+t;h=`${R}${e}`}const g=typeof window<"u"&&window.location.hostname.includes("github.io"),A=["POST","PUT","PATCH","DELETE"].includes(((y=c.method)==null?void 0:y.toUpperCase())||"GET");if(g&&A){console.log(`üöÄ GitHub Pages detectado - fazendo preflight para ${c.method}`);try{await fetch(h,{method:"OPTIONS",mode:"cors",credentials:"omit",headers:{"Access-Control-Request-Method":((T=c.method)==null?void 0:T.toUpperCase())||"POST","Access-Control-Request-Headers":"content-type,accept"}})}catch(e){console.warn("‚ö†Ô∏è Preflight falhou, tentando requisi√ß√£o direta:",e)}}const w=new AbortController,E=setTimeout(()=>w.abort(),a);try{console.log(`üåê Fazendo requisi√ß√£o para: ${h}`);const e=await fetch(h,{...c,headers:d,signal:w.signal,mode:"cors",credentials:"omit"});if(clearTimeout(E),!e.ok){let m={};const b=e.headers.get("content-type");if(b&&b.includes("application/json"))try{m=await e.json()}catch{}if(e.status===405&&g){const C="Erro de CORS no GitHub Pages. Verifique se o backend est√° configurado corretamente.";throw console.error("‚ùå Erro 405 detectado no GitHub Pages - prov√°vel problema de CORS:",{url:h,method:c.method,status:e.status,statusText:e.statusText}),new i(C,e.status,m,t)}const O=m.message||m.error||`HTTP ${e.status}: ${e.statusText}`;throw new i(O,e.status,m,t)}if(e.headers.get("content-length")==="0"||e.status===204)return{};const S=e.headers.get("content-type");return S&&S.includes("application/json")?await e.json():await e.text()}catch(e){if(clearTimeout(E),e instanceof Error&&e.name==="AbortError")throw new i("Request timeout",408,null,t);if(e instanceof TypeError&&e.message.includes("fetch"))throw new i("Network error",0,null,t);if(e instanceof i){if((e.isNetworkError||e.status>=500)&&p<(n||0))return console.warn(`Tentativa ${p} falhou, tentando novamente em ${u}ms...`),await new Promise(P=>setTimeout(P,u)),f(p+1);throw e}throw new i(e instanceof Error?e.message:"Unknown error",0,null,t)}}return f()}const N={get:(t,s)=>l(t,{...s,method:"GET"}),post:(t,s,o)=>l(t,{...o,method:"POST",body:s?JSON.stringify(s):void 0}),put:(t,s,o)=>l(t,{...o,method:"PUT",body:s?JSON.stringify(s):void 0}),patch:(t,s,o)=>l(t,{...o,method:"PATCH",body:s?JSON.stringify(s):void 0}),delete:(t,s)=>l(t,{...s,method:"DELETE"}),async request(t){const{endpoint:s,method:o="GET",data:r,params:a,headers:n={},timeout:u=1e4}=t,c=H(s,a||{}),d={"Content-Type":"application/json",...n},f={method:o,headers:d,timeout:u};return r&&["POST","PUT","PATCH"].includes(o)&&(f.body=JSON.stringify(r)),l(c,f)}};function H(t,s){const o=t.startsWith("/")?t:"/"+t,r=new URL(o,"http://dummy.com");return Object.entries(s).forEach(([a,n])=>{n!=null&&n!==""&&(Array.isArray(n)?n.forEach(u=>r.searchParams.append(a,String(u))):r.searchParams.set(a,typeof n=="boolean"?n.toString():String(n)))}),r.pathname+r.search}const q={getErrorMessage(t){return t instanceof i||t instanceof Error?t.message:"Erro desconhecido"},shouldShowRetry(t){return t instanceof i?t.isNetworkError||t.status>=500:!1},formatErrorForUser(t){var s;if(t instanceof i){let o="";return t.isAuthError?o="Sess√£o expirada. Fa√ßa login novamente.":t.isNetworkError?o="Erro de conex√£o. Verifique sua internet.":t.status===404?o="Recurso n√£o encontrado.":t.status===422?o=((s=t.response)==null?void 0:s.message)||"Dados inv√°lidos.":o=t.message||"Erro interno do servidor.",{message:o,canRetry:this.shouldShowRetry(t)}}return{message:"Erro inesperado. Tente novamente.",canRetry:!0}}};export{i as A,N as a,l as b,H as c,q as e};
